version: '3.8'

# ============================================
# Docker Compose for Testing NEW Project
# This uses your EXISTING VPS PostgreSQL (not Docker PostgreSQL)
# Can run side-by-side with OLD project for testing
# ============================================

services:
  # NOTE: No PostgreSQL service - using host's existing PostgreSQL
  
  # ============================================
  # Auth Service (Shared)
  # ============================================
  auth-service:
    build:
      context: ./Shared/auth-service
      dockerfile: Dockerfile
    container_name: rierco-auth-service-new
    restart: unless-stopped
    environment:
      # Connect to host PostgreSQL
      - DB_HOST=host.docker.internal
      - DB_PORT=5432
      - DB_USER=tireLab
      - DB_PASSWORD=radikal4
      - DB_NAME=tire_laboratory
      - PORT=3005
      - NODE_ENV=production
      - JWT_SECRET=${JWT_SECRET}
      - JWT_EXPIRES_IN=7d
      - CLOUDINARY_CLOUD_NAME=dflapbzi9
      - CLOUDINARY_API_KEY=758797596463665
      - CLOUDINARY_API_SECRET=G1IeZ57LERrszCkgJ-u2w8WTdI8
      - ALLOWED_ORIGINS=https://tire.rierco.net,https://lab.rierco.net,https://auth.rierco.net
    ports:
      - "4005:3005"  # Different port for testing!
    extra_hosts:
      - "host.docker.internal:host-gateway"
    networks:
      - rierco-network-new

  # ============================================
  # Chat Service (Shared)
  # ============================================
  chat-service:
    build:
      context: ./Shared/chat-service
      dockerfile: Dockerfile
    container_name: rierco-chat-service-new
    restart: unless-stopped
    environment:
      - DB_HOST=host.docker.internal
      - DB_PORT=5432
      - DB_USER=tireLab
      - DB_PASSWORD=radikal4
      - DB_NAME=tire_laboratory
      - PORT=3006
      - NODE_ENV=production
      - JWT_SECRET=${JWT_SECRET}
      - AUTH_SERVICE_URL=http://auth-service:3005
      - CLOUDINARY_CLOUD_NAME=dflapbzi9
      - CLOUDINARY_API_KEY=758797596463665
      - CLOUDINARY_API_SECRET=G1IeZ57LERrszCkgJ-u2w8WTdI8
      - ALLOWED_ORIGINS=https://tire.rierco.net,https://lab.rierco.net,https://auth.rierco.net
    ports:
      - "4006:3006"  # Different port for testing!
    extra_hosts:
      - "host.docker.internal:host-gateway"
    depends_on:
      - auth-service
    networks:
      - rierco-network-new

  # ============================================
  # Materials Lab Backend
  # ============================================
  materials-backend:
    build:
      context: ./Materals-Parts-Laboratory-Project/materials-parts-lab-backend
      dockerfile: Dockerfile
    container_name: rierco-materials-backend-new
    restart: unless-stopped
    environment:
      - DB_HOST=host.docker.internal
      - DB_PORT=5432
      - DB_USER=tireLab
      - DB_PASSWORD=radikal4
      - DB_NAME=tire_laboratory
      - MATERIALS_DB_HOST=host.docker.internal
      - MATERIALS_DB_PORT=5432
      - MATERIALS_DB_USER=tireLab
      - MATERIALS_DB_PASSWORD=radikal4
      - MATERIALS_DB_NAME=materials_parts_laboratory
      - PORT=3002
      - NODE_ENV=production
      - JWT_SECRET=${JWT_SECRET}
      - CLOUDINARY_CLOUD_NAME=dflapbzi9
      - CLOUDINARY_API_KEY=758797596463665
      - CLOUDINARY_API_SECRET=G1IeZ57LERrszCkgJ-u2w8WTdI8
      - ALLOWED_ORIGINS=https://tire.rierco.net,https://lab.rierco.net,https://auth.rierco.net
    ports:
      - "4002:3002"  # Different port for testing!
    extra_hosts:
      - "host.docker.internal:host-gateway"
    depends_on:
      - auth-service
    networks:
      - rierco-network-new

  # ============================================
  # Tire Lab Backend
  # ============================================
  tire-backend:
    build:
      context: ./Tire-Laboratory-Project/tire-lab-backend
      dockerfile: Dockerfile
    container_name: rierco-tire-backend-new
    restart: unless-stopped
    environment:
      - NODE_ENV=production
      - PORT=5050
      - PGHOST=host.docker.internal
      - PGUSER=tireLab
      - PGPASSWORD=radikal4
      - PGDATABASE=tire_laboratory
      - PGPORT=5432
      - JWT_SECRET=${JWT_SECRET}
      - CLOUDINARY_CLOUD_NAME=dflapbzi9
      - CLOUDINARY_API_KEY=758797596463665
      - CLOUDINARY_API_SECRET=G1IeZ57LERrszCkgJ-u2w8WTdI8
      - ALLOWED_ORIGINS=https://tire.rierco.net,https://lab.rierco.net,https://auth.rierco.net
    ports:
      - "6050:5050"  # Different port for testing!
    extra_hosts:
      - "host.docker.internal:host-gateway"
    depends_on:
      - auth-service
    networks:
      - rierco-network-new

  # ============================================
  # Auth Frontend
  # ============================================
  auth-frontend:
    build:
      context: ./Shared/auth-frontend
      dockerfile: Dockerfile
      args:
        - VITE_AUTH_URL=http://YOUR_VPS_IP:4005/auth
        - VITE_TIRE_LAB_URL=http://YOUR_VPS_IP:4012
        - VITE_MATERIALS_LAB_URL=http://YOUR_VPS_IP:4011
    container_name: rierco-auth-frontend-new
    restart: unless-stopped
    ports:
      - "4010:80"  # Different port for testing!
    networks:
      - rierco-network-new

  # ============================================
  # Materials Lab Frontend
  # ============================================
  materials-frontend:
    build:
      context: ./Materals-Parts-Laboratory-Project/materials-parts-lab-frontend
      dockerfile: Dockerfile
      args:
        - VITE_BASE_URL=http://YOUR_VPS_IP:4002/api
        - VITE_AUTH_URL=http://YOUR_VPS_IP:4005/auth
        - VITE_AUTH_PORTAL_URL=http://YOUR_VPS_IP:4010
        - VITE_CHAT_URL=http://YOUR_VPS_IP:4006
        - VITE_CURRENT_SYSTEM=materials
    container_name: rierco-materials-frontend-new
    restart: unless-stopped
    ports:
      - "4011:80"  # Different port for testing!
    networks:
      - rierco-network-new

  # ============================================
  # Tire Lab Frontend
  # ============================================
  tire-frontend:
    build:
      context: ./Tire-Laboratory-Project/tire-lab-frontend
      dockerfile: Dockerfile
      args:
        - VITE_BASE_URL=http://YOUR_VPS_IP:6050/api
        - VITE_AUTH_URL=http://YOUR_VPS_IP:4005/auth
        - VITE_AUTH_PORTAL_URL=http://YOUR_VPS_IP:4010
        - VITE_CHAT_URL=http://YOUR_VPS_IP:4006
        - VITE_CURRENT_SYSTEM=tire
    container_name: rierco-tire-frontend-new
    restart: unless-stopped
    ports:
      - "4012:80"  # Different port for testing!
    networks:
      - rierco-network-new

networks:
  rierco-network-new:
    driver: bridge
